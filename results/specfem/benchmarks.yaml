path_tpl: "{platform}/processes={processes}_x_{nex}nex"
script_tpl: "./exec/specfem/run_specfem.py"

remote_mode: false
stop_on_error: false

# oc apply -f https://raw.githubusercontent.com/kubeflow/mpi-operator/v0.3.0/deploy/v2beta1/mpi-operator.yaml
# oc set image -n mpi-operator deployment.apps/mpi-operator mpi-operator=docker.io/mpioperator/mpi-operator:0.3.0
# oc new-project specfem
# oc adm policy add-scc-to-user privileged -z default # (from specfem namespace)
# oc adm policy add-scc-to-user anyuid -z  default  # (from specfem namespace)

# cat << '# EOF' | sed 's/# //' | oc apply -f-
# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: specfem
# spec:
#   accessModes:
#     - ReadWriteOnce
#   resources:
#     requests:
#       storage: 60Gi
# EOF

env:
  SPECFEM_GO_CLIENT_DIR: "/home/kevin/openshift/specfem/specfem-client"
  SPECFEM_GO_CLIENT_DEV_MODE: false

common_settings:
  relyOnSharedFS: true
  platform: openshift
  run: 1
  threads: 16
  network: default

expe_to_run:
- dgx-try

expe:
  dgx-try:
    platform: dgx
    extra:
      - mpi-slots=8, processes=8, nex=64, gpu=on
      - mpi-slots=6, processes=6, nex=64, gpu=on
      - mpi-slots=4, processes=4, nex=64, gpu=on
      - mpi-slots=2, processes=2, nex=64, gpu=on

old_expe:
  threading:
    settings:
      relyOnSharedFS: true
      platform: podman, podman-no-seccomp
      nex: 32
      network: default
      threads: 8, 7, 6, 5, 4, 3, 2, 1
      extra:
        - processes=1, mpi-slots=1, run=2

  libgomp:
    settings:
      platform: baremetal
      nex: 32 #32, 64
      threads: 1, 8, 16, 32, 48, 64, 256, 512, 1024
      extra:
        - processes=1, mpi-slots=1
      libgomp_optim: O0, O2, O3

  NVa100:
    settings:
      platform: openshift
      threads: 8, 16, 32, 64, 96, 128
      network: default
      mpi-slots: 4
      run: 2, 3, 4, 5
      extra:
        - processes=1, nex=64, gpu=off
        - processes=1, nex=128, gpu=off
        - processes=4, nex=128, gpu=off

  openshift:
    settings:
      #gpu: false
      relyOnSharedFS: true
      platform:  baremetal, podman, podman-no-seccomp, podman-hyperthreads #baremetal,  # openshift,
      network: default #, multus #, hostnet
      run: scale-1
      extra:
        # 32 nex
        - nex=32, processes=1, mpi-slots=1 # 1 machine
        - nex=32, processes=4, mpi-slots=2 # 2 machines
        - nex=32, processes=4, mpi-slots=1 # 4 machines

        # 64 nex
        - nex=64, processes=1, mpi-slots=1 # 1 machine
        - nex=64, processes=4, mpi-slots=2 # 2 machines
        - nex=64, processes=4, mpi-slots=1 # 4 machines
        - nex=64, processes=16, mpi-slots=2 # 8 machines
        - nex=64, processes=16, mpi-slots=1 # 16 machines
        - nex=64, processes=64, mpi-slots=2 # 32 machines

        # 96 nex
        - nex=96, processes=4, mpi-slots=1 # 4 machines
        - nex=96, processes=9, mpi-slots=1 # 9 machines
        - nex=96, processes=16, mpi-slots=2 # 8 machines
        - nex=96, processes=16, mpi-slots=1 # 16 machines
        - nex=96, processes=36, mpi-slots=2 # 18 machines

        # 128 NEX
        - processes=4, mpi-slots=1, nex=128 # 4 machines
        - processes=16, mpi-slots=2, nex=128 # 8 machines
        - processes=16, mpi-slots=1, nex=128 # 16 machines
        - processes=64, mpi-slots=2, nex=128 # 32 machines

        # 192 nex
        - nex=192, processes=9, mpi-slots=1 # 9 machines
        - nex=192, processes=16, mpi-slots=1 # 16 machines
        - nex=192, processes=36, mpi-slots=2 # 18 machines
        - nex=192, processes=64, mpi-slots=2 # 32 machines

        # 256 nex
        - nex=256, processes=16, mpi-slots=1 # 16 machines
        - nex=256, processes=64, mpi-slots=2 # 32 machines
